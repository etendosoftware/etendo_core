<?xml version="1.0"?>
  <database name="FUNCTION C_BP_GET_DOCTYPE">
    <function name="C_BP_GET_DOCTYPE" type="VARCHAR">
      <parameter name="p_client_id" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <parameter name="p_org_id" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <parameter name="p_bp_id" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <parameter name="p_docbasetype" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <parameter name="p_is_automation" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <body><![CDATA[v_isso char(1);
  v_category text;
  v_doctype_id character varying;
  v_dbt text := upper(trim(p_docbasetype));
  v_auto boolean := upper(coalesce(p_is_automation,'N')) = 'Y';
BEGIN
  IF v_dbt IN ('SOO','RSO','MMS','RMS','ARI','ARC') THEN
    v_isso := 'Y';
  ELSE
    v_isso := 'N';
  END IF;
  IF v_dbt IN ('SOO','POO','RSO','RPO') THEN
    v_category := 'ORD';
  ELSIF v_dbt IN ('ARI','API','ARC','APC') THEN
    v_category := 'INV';
  ELSIF v_dbt IN ('MMS','MMR','RMS','RMR') THEN
    v_category := 'SHIP';
  ELSE
    v_category := NULL;
  END IF;
  IF v_category IS NULL THEN
    RETURN AD_GET_DOCTYPE(p_client_id, p_org_id, p_docbasetype);
  END IF;
  IF p_bp_id IS NOT NULL AND p_bp_id <> '' THEN
    SELECT bpd.c_doctype_id
      INTO v_doctype_id
      FROM c_bpartner_doctype bpd
     WHERE bpd.isactive = 'Y'
       AND bpd.c_bpartner_id = p_bp_id
       AND bpd.issotrx = v_isso
       AND bpd.documentcategory = v_category
       AND bpd.c_doctype_id IS NOT NULL
       AND (
         CASE WHEN v_auto
              THEN COALESCE(bpd.isforceautomation,'N') = 'Y'
              ELSE TRUE
         END
       )
       AND AD_ISORGINCLUDED(p_org_id, bpd.ad_org_id, bpd.ad_client_id) <> -1
     ORDER BY AD_ISORGINCLUDED(p_org_id, bpd.ad_org_id, bpd.ad_client_id) ASC
     LIMIT 1;
    IF v_doctype_id IS NULL THEN
      SELECT bpd.c_doctype_id
        INTO v_doctype_id
        FROM c_bpartner_doctype bpd
       WHERE bpd.isactive = 'Y'
         AND bpd.c_bpartner_id = p_bp_id
         AND bpd.issotrx = v_isso
         AND bpd.documentcategory = v_category
         AND bpd.c_doctype_id IS NOT NULL
         AND (
           CASE WHEN v_auto
             THEN COALESCE(bpd.isforceautomation,'N') = 'Y'
               ELSE TRUE
           END
         )
         AND bpd.ad_org_id = '0'
       ORDER BY 1
       LIMIT 1;
    END IF;
  END IF;
  IF v_doctype_id IS NULL THEN
    v_doctype_id := AD_GET_DOCTYPE(p_client_id, p_org_id, p_docbasetype);
  END IF;
  RETURN v_doctype_id;
END C_BP_GET_DOCTYPE
]]></body>
    </function>
  </database>
